<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Erriez MH-Z19B CO2 sensor library for Arduino: Main Page</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="MHZ19B.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Erriez MH-Z19B CO2 sensor library for Arduino
   &#160;<span id="projectnumber">1.0.0</span>
   </div>
   <div id="projectbrief">This is a MH-Z19B CO2 sensor library for Arduino with a small footprint.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Erriez MH-Z19B CO2 sensor library for Arduino Documentation</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_README"></a> <a href="https://github.com/Erriez/ErriezMHZ19B/blob/master/LICENSE"><img src="https://img.shields.io/badge/license-MIT-green" alt="Licence MIT" class="inline"/></a> <a href="https://github.com/Erriez/ErriezMHZ19B"><img src="https://img.shields.io/badge/language-C%2FC%2B%2B-informational" alt="Language C/C++" class="inline"/></a> <a href="https://github.com/Erriez/ErriezMHZ19B/releases"><img src="https://img.shields.io/github/v/release/Erriez/ErriezMHZ19B?display_name=tag" alt="Release tag" class="inline"/></a> <a href="https://github.com/Erriez/ErriezMHZ19B/issues"><img src="https://shields.io/github/issues-raw/Erriez/ErriezMHZ19B" alt="Open issue" class="inline"/></a> <a href="https://github.com/Erriez/ErriezMHZ19B/actions/workflows/actions.yml"><img src="https://github.com/Erriez/ErriezMHZ19B/actions/workflows/actions.yml/badge.svg" alt="PlatformIO CI" style="pointer-events: none;" class="inline"/></a></p>
<h1>Erriez MH-Z19B/C CO2 sensor library for Arduino</h1>
<p>This is a MH-Z19B / MH-Z19C CO2 sensor library for Arduino. It has been built from scratch to support hardware and software serial with a small footprint.</p>
<p>The MH-Z19 is a NDIR (Non-Dispersive Infrared) type gas sensor with built-in temperature compensation to measure CO2 concentration in air.</p>
<p><img src="https://raw.githubusercontent.com/Erriez/ErriezMHZ19B/master/extras/MHZ19B.png" alt="MHZ19B" class="inline"/></p>
<h2>Library features</h2>
<ul>
<li>Small code/memory footprint</li>
<li>Hardware and software serial interface at 9600 baud 8N1</li>
<li>Read CO2 concentration 400..5000 ppm +/-50ppm+3% minimum 5 seconds interval</li>
<li>Chip detection</li>
<li>Smart warming-up detection</li>
<li>Read firmware version</li>
<li>Set/get range 2000 or 5000 ppm</li>
<li>Set/get auto calibration (Automatic Baseline Correction 24h interval)</li>
<li>Manual 400ppm calibration command</li>
<li>CRC checks on communication protocol and timeout handling</li>
<li>Interface for sending undocumented commands</li>
</ul>
<h3>Pins</h3>
<div class="fragment"><div class="line"> {c++}</div>
<div class="line">// MH-Z19B front connector</div>
<div class="line">//     __     _______</div>
<div class="line">// +------------------+</div>
<div class="line">// |                  |</div>
<div class="line">// |   . . . . . . .  |</div>
<div class="line">// |   1 2 3 4 5 6 7  |</div>
<div class="line">// +------------------+</div>
<div class="line">//</div>
<div class="line">// Pin 1: Yellow  None</div>
<div class="line">// Pin 2: Green   UART (TXD) TTL Level Data Output  -&gt; TO RXD</div>
<div class="line">// Pin 3: Blue    UART(RXD) TTL Level Data Input    -&gt; TO TXD</div>
<div class="line">// Pin 4: Red     Positive Power Supply (Vin +5V)</div>
<div class="line">// Pin 5: Black   Negative Power Supply (GND)</div>
<div class="line">// Pin 6: White   None</div>
<div class="line">// Pin 7: Brown   Analog Output Vo (Not used)</div>
<div class="line">//</div>
<div class="line">// The following ESP8266 pins are reserved:</div>
<div class="line">//    TX/RX:  Serial (in use)</div>
<div class="line">//    A0:     Analog (cannot be used)</div>
<div class="line">//    D0-RST: Wake (cannot be used)</div>
<div class="line">//    D1/D2:  I2C (can be used when I2C not used)</div>
<div class="line">//    D3:     Output data flash (corrupts MH-Z19B on boot)</div>
<div class="line">//    D4:     Boot (in use by boot pin / LED)</div>
<div class="line">//    D5..D8: SPI &lt;- Can be used when SPI not used</div>
</div><!-- fragment --><h2>Tested Hardware</h2>
<p>The following targets are supported and tested:</p>
<ul>
<li>AVR: UNO, MINI, Pro Mini 8/16 MHz, ATMega2560, Leonardo</li>
<li>ARM: DUE</li>
<li>ESP8266: Mini D1 &amp; D2, NodeMCU</li>
<li>ESP32: Lolin D32</li>
</ul>
<h2>Examples</h2>
<ul>
<li><a href="https://github.com/Erriez/ErriezMHZ19B/tree/master/examples/ErriezMHZ19BGettingStarted">ErriezMHZ19BGettingStarted</a></li>
<li><a href="https://github.com/Erriez/ErriezMHZ19B/tree/master/examples/ErriezMHZ19BSerialPlottter">ErriezMHZ19BSerialPlottter</a></li>
<li><a href="https://github.com/Erriez/ErriezMHZ19B/tree/master/examples/ErriezMHZ19B7SegmentDisplay">ErriezMHZ19B7SegmentDisplay</a></li>
</ul>
<h2>Documentation</h2>
<ul>
<li><a href="https://erriez.github.io/ErriezMHZ19B">Online HTML</a></li>
<li><a href="https://github.com/Erriez/ErriezMHZ19B/blob/gh-pages/ErriezMHZ19B.pdf">Doxygen PDF</a></li>
<li><a href="https://github.com/Erriez/ErriezMHZ19B/blob/master/extras/mh-z19b-co2-ver1_0.pdf">Datasheet PDF</a></li>
</ul>
<h2>CO2 Concentrations</h2>
<p>The table below displays the human impact of CO2:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">CO2 ppm   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0..399   </td><td class="markdownTableBodyNone">Incorrect values. Minimum value starts at 400ppm outdoor fresh air.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">400..1000   </td><td class="markdownTableBodyNone">Concentrations typical of occupied indoor spaces with good air exchange.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">1000..2000   </td><td class="markdownTableBodyNone">Complaints of drowsiness and poor air quality. Ventilation is required.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">2000..5000   </td><td class="markdownTableBodyNone">Headaches, sleepiness and stagnant, stale, stuffy air. Poor concentration, loss of attention, increased heart rate and slight nausea may also be present.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">&gt;5000   </td><td class="markdownTableBodyNone">Higher values are extremely dangerous and cannot be measured by this sensor.   </td></tr>
</table>
<h2>Usage</h2>
<ul>
<li>Operating voltage is between 4.5 and 5VDC, 150mA peak current (average &lt; 60mA).</li>
<li>UART pins are compatible with processors running at 3.3V without level converters.</li>
<li>Keep sensor outside direct sunlight.</li>
</ul>
<h3>Calibration</h3>
<p>The sensor requires an internal calibration regularly. Without it, the minimum value drifts away which is noticeable after a few weeks of operation. With my experiments, the minimum value was drifted to 800ppm after 3 months continues operation without a calibration.</p>
<p>There are two calibration options:</p>
<ol type="1">
<li>Automatic calibration, performed every 24 hours (default).</li>
<li>Manual calibration.</li>
</ol>
<h3>1. Automatic Calibration</h3>
<p>Automatic calibration is recommended when the sensor cannot be moved outdoor with fresh air. This calibration method requires a regularly ventilated room at 400ppm, at least once in 1..3 weeks. Additionally, it requires continues power-up without interruptions, otherwise the calibration data will not be updated correctly.</p>
<p>Automatic calibration configuration:</p>
<ul>
<li>Set auto calibration on: <code>setAutoCalibration(true)</code> (Default from manufacture).</li>
<li>Set auto calibration off: <code>setAutoCalibration(false)</code>.</li>
</ul>
<p>The status can be read with function <code>getAutoCalibration()</code>.</p>
<p><b>Note:</b> <br  />
 For simplicity, this library uses the terminology <code>Automatic Calibration</code> which is identical to the <code>ABC (Automatic Baseline Correction) logic on/off</code> mentioned in the datasheet.</p>
<h3>2. Manual Calibration (400ppm)</h3>
<p>Procedure for manual calibration at 400ppm:</p>
<ul>
<li>Turn automatic calibration off.</li>
<li>Power the sensor up outdoor in fresh air for at least 20 minutes. (Not in a forest or a farm which produces background CO2)</li>
<li>Call <code>startZeroCalibration()</code> once. This will send command <code>0x87 Zero Point Calibration</code>, but is not a zero calibration as stated in the datasheet. There is no nitrogen needed as this calibration is performed at 400ppm.</li>
</ul>
<p>Now the sensor is calibrated. Repeat the sequence more often for higher accuracy.</p>
<h3>3. Manual Calibration (SPAN)</h3>
<p>The datasheet also mentions a command <code>0x88 Span Point Calibration</code>. The calibration procedure is not clear and therefore not implemented in this library.</p>
<h2>MH-Z19B API</h2>
<p><b>Initialization Software Serial</b></p>
<p>Use a Software Serial when no hardware serial is available. Sometimes a 3rd party library is required, for example for ESP32 targets by installing <code>ESPSoftwareSerial</code>. It must be installed into <code>.arduino15/packages/esp32/hardware/esp32/&lt;version&gt;/libraries/EspSoftwareSerial</code>, because the library contains a naming conflict with existing <code>SoftwareSerial.h</code> built-in libraries.</p>
<div class="fragment"><div class="line"> {c++}</div>
<div class="line">#include &lt;ErriezMHZ19B.h&gt;</div>
<div class="line">#include &lt;SoftwareSerial.h&gt;</div>
<div class="line"> </div>
<div class="line">// Pin defines</div>
<div class="line">#define MHZ19B_TX_PIN        4</div>
<div class="line">#define MHZ19B_RX_PIN        5</div>
<div class="line"> </div>
<div class="line">// Create software serial object</div>
<div class="line">SoftwareSerial mhzSerial(MHZ19B_TX_PIN, MHZ19B_RX_PIN);</div>
<div class="line"> </div>
<div class="line">// Create MHZ19B object with software serial</div>
<div class="line">ErriezMHZ19B mhz19b(&amp;mhzSerial);</div>
</div><!-- fragment --><p><b>Initialization Hardware Serial</b></p>
<p>Any hardware serial like <code>Serial</code>, <code>Serial1</code>, <code>Serial2</code> etc can be used when supported by the CPU. Multiple hardware serial ports are only available on targets like ATMEGA2560, Leonardo and SAM DUE boards:</p>
<div class="fragment"><div class="line"> {c++}</div>
<div class="line">#include &lt;ErriezMHZ19B.h&gt;</div>
<div class="line"> </div>
<div class="line">// Create MHZ19B object with hardware serial</div>
<div class="line">ErriezMHZ19B mhz19b(&amp;Serial1);</div>
</div><!-- fragment --><p><b>General initialization</b></p>
<p>The optional items of the initialization sequence can be omitted.</p>
<div class="fragment"><div class="line"> {c++}</div>
<div class="line">void setup()</div>
<div class="line">{</div>
<div class="line">    // Initialize serial</div>
<div class="line">    Serial.begin(115200);</div>
<div class="line">    Serial.println(F(&quot;\nErriez MH-Z19B CO2 Sensor example&quot;));</div>
<div class="line"> </div>
<div class="line">    // Initialize software serial at fixed baudrate</div>
<div class="line">    mhzSerial.begin(9600);</div>
<div class="line"> </div>
<div class="line">    // Optional: Detect MH-Z19B sensor (check wiring / power)</div>
<div class="line">    while ( !mhz19b.detect() ) {</div>
<div class="line">        Serial.println(F(&quot;Detecting MH-Z19B sensor...&quot;));</div>
<div class="line">        delay(2000);</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">    // Sensor requires 3 minutes warming-up after power-on</div>
<div class="line">    while (mhz19b.isWarmingUp()) {</div>
<div class="line">        Serial.println(F(&quot;Warming up...&quot;));</div>
<div class="line">        delay(2000);</div>
<div class="line">    };</div>
<div class="line">}</div>
</div><!-- fragment --><p><b>Read CO2 loop</b></p>
<p>Read CO2 with minimum interval asynchronous function <code>isReady()</code>. A good practice is to check error returns <code>&lt; 0</code>.</p>
<div class="fragment"><div class="line"> {c++}</div>
<div class="line">void loop()</div>
<div class="line">{</div>
<div class="line">    int16_t result;</div>
<div class="line"> </div>
<div class="line">    // Minimum interval between CO2 reads</div>
<div class="line">    if (mhz19b.isReady()) {</div>
<div class="line">        // Read CO2 from sensor</div>
<div class="line">        result = mhz19b.readCO2();</div>
<div class="line"> </div>
<div class="line">        // Print result</div>
<div class="line">        if (result &lt; 0) {</div>
<div class="line">            // Print error code</div>
<div class="line">            switch (result) {</div>
<div class="line">                case MHZ19B_RESULT_ERR_CRC:</div>
<div class="line">                    Serial.println(F(&quot;CRC error&quot;));</div>
<div class="line">                    break;</div>
<div class="line">                case MHZ19B_RESULT_ERR_TIMEOUT:</div>
<div class="line">                    Serial.println(F(&quot;RX timeout&quot;));</div>
<div class="line">                    break;</div>
<div class="line">                default:</div>
<div class="line">                    Serial.print(F(&quot;Error: &quot;));</div>
<div class="line">                    Serial.println(result);</div>
<div class="line">                    break;</div>
<div class="line">            }</div>
<div class="line">        } else {</div>
<div class="line">            // Print CO2 concentration in ppm</div>
<div class="line">            Serial.print(result);</div>
<div class="line">            Serial.println(F(&quot; ppm&quot;));</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p><b>Print internal settings</b></p>
<p>All tests are performed with sensor version string <code>"0443"</code>.</p>
<div class="fragment"><div class="line"> {c++}</div>
<div class="line">char firmwareVersion[5];</div>
<div class="line"> </div>
<div class="line">// Optional: Print firmware version</div>
<div class="line">Serial.print(F(&quot;  Firmware: &quot;));</div>
<div class="line">mhz19b.getVersion(firmwareVersion, sizeof(firmwareVersion));</div>
<div class="line">Serial.println(firmwareVersion);</div>
<div class="line"> </div>
<div class="line">// Optional: Set CO2 range 2000ppm or 5000ppm (default) once</div>
<div class="line">// Serial.print(F(&quot;Set range...&quot;));</div>
<div class="line">// mhz19b.setRange2000ppm();</div>
<div class="line">// mhz19b.setRange5000ppm();</div>
<div class="line"> </div>
<div class="line">// Optional: Print operating range</div>
<div class="line">Serial.print(F(&quot;  Range: &quot;));</div>
<div class="line">Serial.print(mhz19b.getRange());</div>
<div class="line">Serial.println(F(&quot;ppm&quot;));</div>
<div class="line"> </div>
<div class="line">// Optional: Print Automatic Baseline Calibration status</div>
<div class="line">Serial.print(F(&quot;  Auto calibrate: &quot;));</div>
<div class="line">Serial.println(mhz19b.getAutoCalibration() ? F(&quot;On&quot;) : F(&quot;Off&quot;));</div>
</div><!-- fragment --><p><b>Set automatic calibration</b></p>
<p>Turn automatic calibration on or off once at startup:</p>
<div class="fragment"><div class="line"> {c++}</div>
<div class="line">// Optional: Set automatic calibration on (true) or off (false) once</div>
<div class="line">mhz19b.setAutoCalibration(true);</div>
</div><!-- fragment --><h3>Documented commands</h3>
<p>The following commands are documented, used and tested by the library:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Command   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x79   </td><td class="markdownTableBodyNone">Set auto calibration on/off    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x86   </td><td class="markdownTableBodyNone">Read CO2 concentration    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x87   </td><td class="markdownTableBodyNone">Calibration zero point at 400ppm (not 0 ppm)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x88   </td><td class="markdownTableBodyNone">Calibrate span point (NOT IMPLEMENTED)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x99   </td><td class="markdownTableBodyNone">Set detection range   </td></tr>
</table>
<h3>Not documented commands (tested)</h3>
<p>The following commands are <b>not documented</b>, are used and tested by the library:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Command   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x7D   </td><td class="markdownTableBodyNone">Get auto calibration status (NOT DOCUMENTED)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x9B   </td><td class="markdownTableBodyNone">Get range detection (NOT DOCUMENTED)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0xA0   </td><td class="markdownTableBodyNone">Get firmware version (NOT DOCUMENTED)   </td></tr>
</table>
<p>More information about undocumented commands: <a href="https://revspace.nl/MH-Z19B">https://revspace.nl/MH-Z19B</a>.</p>
<p><b>NOTE:</b> Sending untested commands may damage the sensor permanently! Use at your own risk.</p>
<div class="fragment"><div class="line"> {c++}</div>
<div class="line">int16_t result;</div>
<div class="line"> </div>
<div class="line">result = mhz19b.sendCommand(MHZ19B_CMD_NOT_DOCUMENTED, 0x00, 0x00, 0x00, 0x00, 0x00);</div>
<div class="line"> </div>
<div class="line">// 9 Bytes response is located in mhz19b.rxBuffer[9]</div>
</div><!-- fragment --><h2>Library configuration</h2>
<p>Unfortunately, the sensor has no possibility to read warming-up status, so the library must wait at least 3 minutes after reset or power-on. To speedup the boot process, macro <code>MHZ19B_SMART_WARMING_UP</code> can be enabled in <code><a class="el" href="_erriez_m_h_z19_b_8h.html" title="MH-Z19B CO2 sensor library for Arduino.">ErriezMHZ19B.h</a></code> to enable smart warming-up when the MCU is reset and MH-Z19B powered &gt; 3 minutes.</p>
<h2>Response timing</h2>
<p>The screenshot below displays the response timing of a synchronous readCO2() call which takes 22.1ms on an Arduino UNO:</p><ul>
<li>9.4ms: Transmit 9 Bytes at 9600 baud</li>
<li>3.2ms: MH-Z19B to process command</li>
<li>9.3ms: Return response 9 Bytes at 9600 baud</li>
<li>183us: Arduino UNO to process response with Software Serial.</li>
</ul>
<p><img src="extras/LogicAnalyzerScreenshotMHZ19BUNOReadCO2.png" alt="Logic Analyzer Screenshot MHZ19B UNO readCO2()" class="inline"/></p>
<h2>Library installation</h2>
<p>Please refer to the <a href="https://github.com/Erriez/ErriezArduinoLibrariesAndSketches/wiki">Wiki</a> page.</p>
<h2>Other Arduino Libraries and Sketches from Erriez</h2>
<p><a href="https://github.com/Erriez/ErriezArduinoLibrariesAndSketches">Erriez Libraries and Sketches</a></p>
<h2>MIT License</h2>
<p>This project is published under <a href="https://github.com/Erriez/ErriezMHZ19B/blob/master/LICENSE">MIT license</a> with an additional end user agreement (next section).</p>
<h2>End User Agreement :ukraine:</h2>
<p>End users shall accept the <a href="https://github.com/Erriez/ErriezMHZ19B/blob/master/END_USER_AGREEMENT.md">End User Agreement</a> holding export restrictions to Russia to stop the WAR before using this project. </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
